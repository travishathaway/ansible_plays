- name: Clone repository
  become: yes
  become_user: "{{crimestats_app_user}}"
  git: dest={{crimestats_app_root}}
       repo=git://github.com/travishathaway/crimestats.git
       accept_hostkey=yes

- name: Install gunicorn
  command: "{{crimestats_bin}}/conda install gunicorn -y"

- name: Install conda dependencies
  command: "{{crimestats_bin}}/conda install --file {{crimestats_app_root}}conda_requirements.txt -y"

- name: Install dependencies
  pip: executable={{crimestats_bin}}/pip
       requirements={{crimestats_app_root}}requirements.txt

- name: Copy upstart config
  become: yes
  become_method: sudo
  template: src=crimestats.conf dest=/etc/init/crimestats.conf

- name: Copy gunicorn ini
  become: yes
  become_user: "{{crimestats_app_user}}"
  template: src=crimestats.ini 
            dest={{crimestats_app_root}}crimestats.ini

- name: Start crimestats service
  become: yes
  become_method: sudo
  service: name=crimestats state=restarted
